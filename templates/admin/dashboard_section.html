{% extends 'admin/admin_home.html' %}

{% load static %}
{% load humanize %}
{% block content %}
<div id="dashboard" class="section p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
        {% if is_admin %}
                T·ªïng Quan H·ªá Th·ªëng
            {% elif is_agent %}
                Dashboard ƒê·∫°i L√Ω
            {% endif %}
        </h2>
        <div class="flex space-x-3">
            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors" onclick="refreshCharts(event)">
                <i class="fas fa-sync-alt mr-2"></i>C·∫≠p Nh·∫≠t
            </button>
            {% if is_admin %}
            <button class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity" onclick="exportReport()">
                <i class="fas fa-download mr-2"></i>Xu·∫•t B√°o C√°o
            </button>
            {% elif is_agent %}
            <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors" onclick="exportAgentReport()">
                <i class="fas fa-download mr-2"></i>Xu·∫•t B√°o C√°o C√° Nh√¢n
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Cards -->
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Card 1: T·ªïng kh√°ch h√†ng -->
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">
                        {% if is_admin %}T·ªïng Kh√°ch H√†ng{% elif is_agent %}Kh√°ch H√†ng C·ªßa T√¥i{% endif %}
                    </p>
                    <p class="text-2xl font-bold text-gray-800">{{ total_customers|intcomma }}</p>
                    <p class="text-xs text-green-600 mt-1">
                        {% if is_admin %}
                            {{ active_customers }} ƒëang ho·∫°t ƒë·ªông
                        {% elif is_agent %}
                            {{ active_customers }} ƒëang ho·∫°t ƒë·ªông
                        {% endif %}
                    </p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Card 2: H·ª£p ƒë·ªìng -->
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">
                        {% if is_admin %}H·ª£p ƒê·ªìng ƒêang Ho·∫°t ƒê·ªông{% elif is_agent %}H·ª£p ƒê·ªìng C·ªßa T√¥i{% endif %}
                    </p>
                    <p class="text-2xl font-bold text-gray-800">{{ active_policies_count }}</p>
                    <p class="text-xs {% if is_admin %}text-green-600{% else %}text-blue-600{% endif %} mt-1">
                        {% if is_admin %}
                            {{ pending_policies }} ch·ªù x·ª≠ l√Ω
                        {% elif is_agent %}
                            {{ my_pending_policies }} ch·ªù x·ª≠ l√Ω
                        {% endif %}
                    </p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fas fa-file-contract text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Card 3: Y√™u c·∫ßu b·ªìi th∆∞·ªùng -->
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">
                        {% if is_admin %}Y√™u C·∫ßu B·ªìi Th∆∞·ªùng{% elif is_agent %}Y√™u C·∫ßu B·ªìi Th∆∞·ªùng{% endif %}
                    </p>
                    <p class="text-2xl font-bold text-gray-800">
                        {% if is_admin %}
                            {{ pending_claims_count }}
                        {% elif is_agent %}
                            {{ my_pending_claims }}
                        {% endif %}
                    </p>
                    <p class="text-xs text-yellow-600 mt-1">ƒëang ch·ªù x·ª≠ l√Ω</p>
                </div>
                <div class="bg-orange-100 p-3 rounded-full">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Card 4: Doanh thu -->
        <div class="bg-white rounded-xl shadow-sm p-6 card-hover transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm">
                        {% if is_admin %}Doanh Thu Th√°ng{% elif is_agent %}Doanh Thu C√° Nh√¢n{% endif %}
                    </p>
                    <p class="text-2xl font-bold text-gray-800">
                        {% if is_admin %}
                            {{ monthly_revenue }} t·ª∑
                        {% elif is_agent %}
                            {{ my_monthly_revenue }} tri·ªáu
                        {% endif %}
                    </p>
                    <p class="text-xs text-green-600 mt-1">
                        {% if is_admin %}
                            t·ª´ {{ active_policies_count }} h·ª£p ƒë·ªìng
                        {% elif is_agent %}
                            t·ª´ {{ active_policies_count }} h·ª£p ƒë·ªìng
                        {% endif %}
                    </p>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Bi·ªÉu ƒê·ªì - Hi·ªÉn th·ªã kh√°c nhau -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Bi·ªÉu ƒë·ªì doanh thu -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                {% if is_admin %}Doanh Thu To√†n H·ªá Th·ªëng{% elif is_agent %}Doanh Thu C√° Nh√¢n{% endif %}
            </h3>
            <div class="h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì ph√¢n lo·∫°i -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                {% if is_admin %}Ph√¢n Lo·∫°i H·ª£p ƒê·ªìng{% elif is_agent %}H·ª£p ƒê·ªìng C·ªßa T√¥i{% endif %}
            </h3>
            <div class="h-64">
                <canvas id="contractChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activities & Th·ªëng K√™ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                {% if is_admin %}Ho·∫°t ƒê·ªông G·∫ßn ƒê√¢y{% elif is_agent %}Ho·∫°t ƒê·ªông C·ªßa T√¥i{% endif %}
            </h3>
            <div class="space-y-4" id="recentActivities">
                {% for activity in recent_activities %}
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 {{ activity.color }} rounded-full mt-2"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">{{ activity.message }}</p>
                        <p class="text-xs text-gray-500 mt-1">{{ activity.time }}</p>
                    </div>
                </div>
                {% empty %}
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-gray-400 rounded-full mt-2"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">
                            {% if is_admin %}ƒêang t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông...{% elif is_agent %}Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o{% endif %}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">{% now "H:i - d/m/Y" %}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                {% if is_admin %}Th·ªëng K√™ Hi·ªáu Su·∫•t{% elif is_agent %}Hi·ªáu Su·∫•t C√° Nh√¢n{% endif %}
            </h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">
                            {% if is_admin %}T·ª∑ L·ªá Ph√™ Duy·ªát{% elif is_agent %}T·ª∑ L·ªá Th√†nh C√¥ng{% endif %}
                        </span>
                        <span class="text-sm font-bold text-green-600">{{ approval_rate }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: {{ approval_rate }}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Th·ªùi Gian X·ª≠ L√Ω TB</span>
                        <span class="text-sm font-bold text-blue-600">{{ avg_processing_time }} ng√†y</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: {% widthratio avg_processing_time 7 100 %}%"></div>
                    </div>
                </div>
                {% if is_admin %}
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">H√†i L√≤ng Kh√°ch H√†ng</span>
                        <span class="text-sm font-bold text-purple-600">{{ customer_satisfaction }}/5</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: {% widthratio customer_satisfaction 5 100 %}%"></div>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">T·ªïng s·ªë Qu·∫£n tr·ªã vi√™n</span>
                        <span class="text-sm font-bold text-orange-600">{{ staff_users }} ng∆∞·ªùi</span>
                    </div>
                </div>
                {% elif is_agent %}
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Kh√°ch H√†ng M·ªõi</span>
                        <span class="text-sm font-bold text-purple-600">{{ new_customers_this_month }} th√°ng n√†y</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: {% widthratio new_customers_this_month 20 100 %}%"></div>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">Hoa H·ªìng Th√°ng</span>
                        <span class="text-sm font-bold text-orange-600">{{ monthly_commission }} tri·ªáu</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Bi·∫øn to√†n c·ª•c cho bi·ªÉu ƒë·ªì
let revenueChart, contractChart;

// H√†m kh·ªüi t·∫°o bi·ªÉu ƒë·ªì v·ªõi d·ªØ li·ªáu
function initializeCharts(data) {
    console.log('üéØ Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì v·ªõi data:', data);

    // X√≥a bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i
    if (revenueChart) revenueChart.destroy();
    if (contractChart) contractChart.destroy();

    // Bi·ªÉu ƒë·ªì doanh thu
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        console.log('üìä T·∫°o revenue chart v·ªõi data:', data.revenue_chart);
        revenueChart = new Chart(revenueCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.revenue_chart.labels || ['Th1', 'Th2', 'Th3', 'Th4', 'Th5', 'Th6'],
                datasets: [{
                    label: '{% if is_admin %}Doanh Thu (t·ª∑ VNƒê){% elif is_agent %}Doanh Thu (tri·ªáu VNƒê){% endif %}',
                    data: data.revenue_chart.data || [0, 0, 0, 0, 0, 0],
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% if is_admin %}T·ª∑ VNƒê{% elif is_agent %}Tri·ªáu VNƒê{% endif %}'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Th√°ng'
                        }
                    }
                }
            }
        });
        console.log('‚úÖ Revenue chart created');
    } else {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y revenueChart canvas');
    }

    // Bi·ªÉu ƒë·ªì ph√¢n lo·∫°i h·ª£p ƒë·ªìng
    const contractCtx = document.getElementById('contractChart');
    if (contractCtx) {
        console.log('üìà T·∫°o contract chart v·ªõi data:', data.contract_chart);
        contractChart = new Chart(contractCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: data.contract_chart.labels || ['Kh√¥ng c√≥ d·ªØ li·ªáu'],
                datasets: [{
                    data: data.contract_chart.data || [1],
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#84cc16'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Ph√¢n Lo·∫°i H·ª£p ƒê·ªìng'
                    }
                }
            }
        });
        console.log('‚úÖ Contract chart created');
    } else {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y contractChart canvas');
    }
}

// H√†m l√†m m·ªõi bi·ªÉu ƒë·ªì v·ªõi API - S·ª¨A L·∫†I
function refreshCharts(event) {
    console.log('üîÑ L√†m m·ªõi bi·ªÉu ƒë·ªì...');

    const refreshBtn = event.target.closest('button');
    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang c·∫≠p nh·∫≠t...';
    refreshBtn.disabled = true;

    fetch('/admin/data/')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('üì• Data nh·∫≠n ƒë∆∞·ª£c:', data);
            initializeCharts(data); // KH·ªûI T·∫†O L·∫†I ho√†n to√†n
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
            showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
        })
        .catch(error => {
            console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì:', error);
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
            showNotification('C√≥ l·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.', 'error');
        });
}

// Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì khi trang load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Trang ƒë√£ load, g·ªçi API ƒë·ªÉ l·∫•y data...');

    fetch('/admin/data/')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log('üìä Data kh·ªüi t·∫°o:', data);
            initializeCharts(data);
        })
        .catch(error => {
            console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu:', error);
            // Kh·ªüi t·∫°o v·ªõi d·ªØ li·ªáu m·∫´u
            initializeCharts({
                revenue_chart: { labels: ['Th1', 'Th2', 'Th3', 'Th4', 'Th5', 'Th6'], data: [0, 0, 0, 0, 0, 0] },
                contract_chart: { labels: ['Kh√¥ng c√≥ d·ªØ li·ªáu'], data: [1] }
            });
            showNotification('ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u.', 'info');
        });
});

// H√†m hi·ªÉn th·ªã th√¥ng b√°o (gi·ªØ nguy√™n)
function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;

    const icon = type === 'success' ? 'fa-check-circle' :
                 type === 'error' ? 'fa-exclamation-circle' :
                 'fa-info-circle';

    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${icon} mr-2"></i>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(toast);

    // T·ª± ƒë·ªông x√≥a sau 4 gi√¢y
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 4000);
}

// Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì khi trang load
document.addEventListener('DOMContentLoaded', function() {
    // G·ªçi API ngay khi trang load ƒë·ªÉ l·∫•y d·ªØ li·ªáu th·ª±c
    fetch('/admin/data/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('D·ªØ li·ªáu kh·ªüi t·∫°o:', data);
            initializeCharts(data);
        })
        .catch(error => {
            console.error('L·ªói khi t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu:', error);
            // Kh·ªüi t·∫°o v·ªõi d·ªØ li·ªáu m·∫´u n·∫øu API l·ªói
            initializeCharts({});
            showNotification('ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u. Vui l√≤ng c·∫≠p nh·∫≠t ƒë·ªÉ l·∫•y d·ªØ li·ªáu th·ª±c.', 'info');
        });
});
</script>

<style>
.gradient-bg {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card-hover:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

/* Animation cho loading */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}